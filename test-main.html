<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <h1 id="stage-title">1-Bosqich</h1>
        <div class="test-area">
            <h2 id="question-prompt" style="font-size: 1.8em;"></h2>
            <img id="question-image" style="display:none;">
            <div id="answer-area"></div>
        </div>
        <div id="feedback"></div>
        <div id="lives"></div>
    </div>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const testWords = JSON.parse(sessionStorage.getItem('testWords'));
        if (!testWords || testWords.length === 0) {
            window.location.href = 'test-selection.html';
            return;
        }

        const stageTitleEl = document.getElementById('stage-title');
        const questionPromptEl = document.getElementById('question-prompt');
        const answerAreaEl = document.getElementById('answer-area');
        const feedbackEl = document.getElementById('feedback');
        const livesEl = document.getElementById('lives');
        const container = document.querySelector('.container');

        let currentWordIndex = 0;
        let lives = 2;
        let score = 0;
        let currentWord = testWords[currentWordIndex];

        function startTest() {
            loadStage1();
        }

        function loadStage1() {
            if (currentWordIndex >= testWords.length) {
                showResults(); // Agar so'zlar tugasa, natijani ko'rsatish
                return;
            }
            currentWord = testWords[currentWordIndex];
            lives = 2;
            updateLives();
            feedbackEl.textContent = '';
            
            stageTitleEl.textContent = "1-Bosqich: To'g'ri yozing";
            questionPromptEl.textContent = currentWord.uzbek;
            answerAreaEl.innerHTML = `<div class="spelling-inputs" id="spelling-inputs"></div>`;
            const inputsContainer = document.getElementById('spelling-inputs');
            
            for (let i = 0; i < currentWord.korean.length; i++) {
                inputsContainer.innerHTML += `<input type="text" maxlength="1" autocomplete="off">`;
            }
            
            const inputs = inputsContainer.querySelectorAll('input');
            inputs[0].focus();
            
            inputs.forEach((input, index) => {
                input.addEventListener('input', () => {
                    if (input.value && index < inputs.length - 1) {
                        inputs[index + 1].focus();
                    }
                    checkFullAnswer();
                });
                input.addEventListener('keydown', (e) => {
                    if (e.key === "Backspace" && !input.value && index > 0) {
                        inputs[index - 1].focus();
                    }
                });
            });
        }
        
        function checkFullAnswer() {
            const inputs = document.querySelectorAll('#spelling-inputs input');
            let answeredWord = '';
            inputs.forEach(input => answeredWord += input.value);

            if (answeredWord.length === currentWord.korean.length) {
                if (answeredWord === currentWord.korean) {
                    feedbackEl.textContent = "‚úÖ To'g'ri!";
                    feedbackEl.style.color = 'green';
                    score++;
                    disableInputs(true);
                    setTimeout(nextQuestion, 1500);
                } else {
                    lives--;
                    updateLives();
                    feedbackEl.textContent = "‚ùå Xato!";
                    feedbackEl.style.color = 'red';
                    if (lives === 0) {
                        feedbackEl.textContent += ` To'g'ri javob: ${currentWord.korean}`;
                        disableInputs(true);
                        setTimeout(nextQuestion, 2500);
                    } else {
                        // Qayta urinish uchun katakchalarni tozalash
                        setTimeout(() => { 
                            inputs.forEach(input => input.value = '');
                            inputs[0].focus();
                            feedbackEl.textContent = "Qayta urining...";
                         }, 1000);
                    }
                }
            }
        }

        function disableInputs(state) {
            document.querySelectorAll('#spelling-inputs input').forEach(input => input.disabled = state);
        }
        
        function nextQuestion() {
            currentWordIndex++;
            loadStage1();
        }
        
        function showResults() {
             container.innerHTML = `
                <h1>üèÜ Test Yakunlandi!</h1>
                <p style="font-size: 1.2em;">Natijangiz:</p>
                <h2 style="font-size: 2.5em;">${score} / ${testWords.length}</h2>
                <a href="test-selection.html" class="btn">Qayta topshirish</a>
                <a href="index.html" class="btn btn-secondary">Bosh sahifaga</a>
             `;
        }

        function updateLives() {
            livesEl.innerHTML = 'Imkoniyatlar: ' + '‚ù§Ô∏è '.repeat(lives) + 'üñ§ '.repeat(2 - lives);
        }
        
        startTest();
    });
    </script>
</body>
</html>
